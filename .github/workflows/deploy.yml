name: Deploy to Cloudflare Pages

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    name: Test Application
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    - name: Install dependencies
      run: |
        npm init -y
        npm install --save-dev http-server playwright @playwright/test
        
    - name: Start local server
      run: |
        npx http-server . -p 8080 &
        sleep 5
        
    - name: Install Playwright Browsers
      run: npx playwright install
      
    - name: Run tests
      run: |
        # Basic health check
        curl -f http://localhost:8080 || exit 1
        # Check if Puter.js is accessible
        curl -f https://js.puter.com/v2/ || exit 1
        echo "âœ… æ‰€æœ‰æ¸¬è©¦é€šé"
        
    - name: Validate HTML
      run: |
        # Check if index.html contains required elements
        grep -q "puter" index.html || exit 1
        grep -q "AI å¤šåŠŸèƒ½åŠ©æ‰‹" index.html || exit 1
        echo "âœ… HTML é©—è­‰é€šé"

  deploy:
    needs: test
    runs-on: ubuntu-latest
    name: Deploy to Cloudflare Pages
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    - name: Install Wrangler
      run: npm install -g wrangler
      
    - name: Deploy to Cloudflare Pages
      run: |
        echo "ğŸš€ æº–å‚™éƒ¨ç½²åˆ° Cloudflare Pages..."
        echo "æª”æ¡ˆåˆ—è¡¨ï¼š"
        ls -la
        echo "âœ… éƒ¨ç½²æº–å‚™å®Œæˆ"
        echo "æ³¨æ„ï¼šè«‹åœ¨ Cloudflare Pages Dashboard ä¸­ç¢ºèª GitHub é€£æ¥"
      env:
        CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}

  notify:
    needs: [test, deploy]
    runs-on: ubuntu-latest
    name: Deployment Notification
    if: always()
    
    steps:
    - name: Notify Deployment Status
      run: |
        if [ "${{ needs.test.result }}" = "success" ] && [ "${{ needs.deploy.result }}" = "success" ]; then
          echo "ğŸ‰ éƒ¨ç½²æˆåŠŸï¼"
          echo "âœ… æ¸¬è©¦é€šé"
          echo "âœ… éƒ¨ç½²å®Œæˆ"
          echo "ğŸ“± æ‡‰ç”¨ç¾åœ¨æ‡‰è©²åœ¨ Cloudflare Pages ä¸Šç·š"
        else
          echo "âŒ éƒ¨ç½²å¤±æ•—"
          echo "æ¸¬è©¦çµæœ: ${{ needs.test.result }}"
          echo "éƒ¨ç½²çµæœ: ${{ needs.deploy.result }}"
        fi 